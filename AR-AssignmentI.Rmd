---
title: "AR - Assignment I"
author: "Roger Bukuru"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Question 1

## A

```{r}
library(ggplot2)
library(tidyverse)

rm(list=ls())

# Define x
x = seq(0,1, length.out=100)

#x = rnorm(100,0,1)
# We choose equally spaced notes over the range [0,1]

knots = seq(0,1,length.out=8) # we set this to 8 as the first and last knots will be removed, so this ensures we are left with 6

# Basis functions per Woods formulation

b1 = function(x) {
  rep(1, length(x))
}

b2 = function(x){
  x
}

R_x_z = function(x, z) {
  ((z - 0.5)^2 - 1/12) * ((x - 0.5)^2 - 1/12) / 4 - 
  ((abs(x - z) - 0.5)^4 - 0.5 * (abs(x - z) - 0.5)^2 + 7/240) / 24
}

# Construct the basis matrix

basis_matrix = cbind(b1(x), b2(x),sapply(knots[-c(1,length(knots))],function(k) R_x_z(x,k)))

basis_design_matrix = basis_matrix %>% as_tibble()
                  
colnames(basis_design_matrix) = c("b1", "b2", "b3", "b4", paste0("b", 5:(4 + length(knots))))
basis_design_matrix = basis_design_matrix %>%
                       mutate(x = x)

basis_melted <- reshape2::melt(basis_design_matrix, id.vars = "x")

ggplot(basis_melted, aes(x = x, y = value, color = variable)) + 
  geom_line(size = 1) + 
  labs(title = "Wood Cubic Spline Basis",
       x = "x", y = "Basis Function Value", color = "Basis") +
  #xlim(0, 1) + 
  theme_minimal()

```


# B 

```{r}
set.seed(123)
n <- 100
x = rnorm(n,0,1)

y <- 5 + sin(3 * pi * (x-0.6)) + rnorm(n, sd = 0.5^2)


knots <- seq(min(x), max(x), length.out = 32) # We define length of 32 because the first and last knots will be removed, to ensure we have exactly 30 knots

# Construct penalty matrix
knot_positions <- knots[-c(1, length(knots))]
n_knots = length(knot_positions)
S = matrix(0, n_knots, n_knots)
for(i in 1:n_knots){
  for (j in 1: n_knots){
    S[i,j] = R_x_z(knot_positions[i], knot_positions[j])
  }
}

penalized_regression_spline = function(lambda){
  basis_matrix <- cbind(
  b1(x),
  b2(x),
  sapply(knot_positions, function(k) R_x_z(x, k))
)
  P = lambda * S
  X  = basis_matrix[, 3:ncol(basis_matrix)]
  XtX_plus_p = t(X)%*%X + P 
  XtY = t(X)%*%y
  beta_hat = solve(XtX_plus_p)%*%XtY
  fitted_values = X %*% beta_hat
  H = X %*% solve(XtX_plus_p) %*% t(X)
  se_errors = sqrt(diag(H))
  return (list(fitted_values = fitted_values , se_errors = se_errors))
}

fit_result = penalized_regression_spline(0.00000001) # choose a random lambda value

plot_data <- data.frame(x = x, y = y, y_hat = fit_result$fitted_values, se_errors=fit_result$se_errors)

ggplot(plot_data, aes(x = x, y = y)) + 
  geom_point(color = 'black', alpha = 0.6) +
  geom_line(aes(y = y_hat), color = 'blue', size = 1.2) +
  labs(title = "Penalized Regression Spline Fit",
       x = "X",
       y = "Y") +
  theme_minimal()
```


## C

```{r}

# (95% confidence intervals)
upper <- fit_result$fitted_values + 1.96 * fit_result$se_errors
lower <- fit_result$fitted_values - 1.96 * fit_result$se_errors


plot_data <- data.frame(x = x, y = y, y_hat = fit_result$fitted_values, lower = lower, upper = upper)

ggplot(plot_data, aes(x = x, y = y)) + 
  geom_point(color = 'black', alpha = 0.6) +
  geom_line(aes(y = y_hat), color = 'blue', size = 1.2) +
  geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.1, fill = 'blue') +
  labs(title = "Penalized Regression Spline Fit with Confidence Bands",
       x = "X",
       y = "Y") +
  theme_minimal()
```





# D

```{r}

compute_gcv = function(lambda){
  basis_matrix <- cbind(
  b1(x),
  b2(x),
  sapply(knot_positions, function(k) R_x_z(x, k))
)
  P = lambda * S
  X  = basis_matrix[, 3:ncol(basis_matrix)]
  XtX_plus_p = t(X)%*%X + P 
  XtY = t(X)%*%y
  beta_hat = solve(XtX_plus_p)%*%XtY
  fitted_values = X %*% beta_hat
  
  # Compute residuals
  residuals = y - fitted_values
  H = X %*% solve(XtX_plus_p)%*%t(X)
  edf = sum(diag(H))
  
  # Compute the GCV score
  n = length(y)
  gcv = sum(residuals^2)/(n*(1-edf/n)^2)
  return (gcv)
}

lambda_values <- seq(0.00000001, 1, length.out = 5000)
gcv_scores <- sapply(lambda_values, compute_gcv)

gcv_data <- data.frame(lambda = lambda_values, gcv = gcv_scores)

ggplot(gcv_data, aes(x = lambda, y = gcv)) +
  geom_line(color = 'blue', size = 1.2) +
  labs(title = "GCV as a Function of the Smoothing Parameter",
       x = "Smoothing Parameter (lambda)",
       y = "GCV Score") +
  theme_minimal()

```


```{r}
pulsar_data = read.csv2("Pulsar.csv", header = TRUE, sep=",")
head(pulsar_data)
```

```{r}

```